
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Meshchain.Ai</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- তোমার পুরাতন CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- হেডার -->
  <header class="header">
    <div class="profile">
      <img src="https://ui-avatars.com/api/?name=Admin&background=00aaff&color=fff" alt="Admin" class="avatar" />
      <div class="user-info">
        <p class="username">অ্যাডমিন</p>
        <div class="verified-badge">Admin</div>
      </div>
    </div>
    <button id="logout-btn" class="btn-logout">লগআউট</button>
  </header>

  <!-- মেইন ট্যাব -->
  <main class="main-content">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="users">ইউজার</button>
      <button class="tab-btn" data-tab="withdraws">উইথড্র হিস্টরি</button>
    </div>

    <!-- ইউজার ট্যাব -->
    <div id="users-tab" class="tab-content">
      <div class="filter-tabs">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="green">Green</button>
        <button class="filter-btn" data-filter="warning">Warning</button>
      </div>
      <div class="search-box">
        <input type="text" id="search-user" placeholder="নাম / আইডি সার্চ করুন..." />
      </div>
      <div id="users-list" class="users-list"></div>
    </div>

    <!-- উইথড্র ট্যাব -->
    <div id="withdraws-tab" class="tab-content" style="display:none;">
      <div class="filter-tabs">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="pending">Pending</button>
        <button class="filter-btn" data-filter="paid">Paid</button>
        <button class="filter-btn" data-filter="failed">Failed</button>
      </div>
      <div id="withdraws-list" class="withdraws-list"></div>
    </div>
  </main>

  <!-- মোডাল -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="modal-title">রিজেক্ট রিজন</h3>
      <textarea id="reject-reason" placeholder="রিজেক্ট রিজন (অপশনাল)"></textarea>
      <div class="modal-actions">
        <button id="modal-confirm" class="btn-primary">নিশ্চিত</button>
        <button id="modal-cancel" class="btn-cancel">বাতিল</button>
      </div>
    </div>
  </div>

  <script>
    // admin.html-এর জন্য সম্পূর্ণ নতুন JavaScript
// ==== তোমার Firebase Config এখানে বসাও ====
const firebaseConfig = {
  apiKey: "AIzaSyCmlgT1e5tWCWQ6yKSO6Z3vd8EJqdgso8A",
  authDomain: "redroseadmin.firebaseapp.com",
  projectId: "redroseadmin",
  storageBucket: "redroseadmin.firebasestorage.app",
  messagingSenderId: "984186362373",
  appId: "1:984186362373:web:5e1e60aead3b468d875a6c",
  measurementId: "G-4HVGTVR3DB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let userFilter = 'all';
let withdrawFilter = 'all';
let currentDocId = null;
let currentUserId = null;
let currentAmount = null;

// ইউজার সেশন চেক
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = 'admin-login.html';
  } else {
    loadUsers();
    loadWithdraws();
  }
});

// লগআউট
document.getElementById('logout-btn').onclick = () => {
  auth.signOut().then(() => {
    window.location.href = 'admin-login.html';
  });
};

// ট্যাব চেঞ্জ
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('users-tab').style.display = 'none';
    document.getElementById('withdraws-tab').style.display = 'none';
    document.getElementById(`${btn.dataset.tab}-tab`).style.display = 'block';
  };
});

// ইউজার ফিল্টার চেঞ্জ
document.querySelectorAll('#users-tab .filter-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#users-tab .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    userFilter = btn.dataset.filter;
    loadUsers();
  };
});

// উইথড্র ফিল্টার চেঞ্জ
document.querySelectorAll('#withdraws-tab .filter-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#withdraws-tab .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    withdrawFilter = btn.dataset.filter;
    loadWithdraws();
  };
});

// ইউজার লিস্ট লোড (রিয়েলটাইম)
function loadUsers() {
  const search = document.getElementById('search-user').value.toLowerCase().trim();
  db.collection('users').onSnapshot(async snapshot => {
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = 'লোড হচ্ছে...';
    
    let users = [];
    const deviceMap = {};
    const referrerMap = {}; // রেফারারের ইউজারনেম সেভ রাখতে
    
    // ইউজার ও ডিভাইস ম্যাপ তৈরি
    snapshot.forEach(doc => {
      const d = { id: doc.id, ...doc.data() };
      if (search && !d.name?.toLowerCase().includes(search) && !d.username?.toLowerCase().includes(search) && !d.id.includes(search)) return;
      
      users.push(d);
      
      const device = d.deviceId || 'unknown';
      if (deviceMap[device]) {
          deviceMap[device].push(d.id);
      } else {
          deviceMap[device] = [d.id];
      }

      // রেফারার আইডি সংগ্রহ
      if (d.referrerId && !referrerMap[d.referrerId]) {
          referrerMap[d.referrerId] = { username: null }; 
      }
    });

    // সকল রেফারারের ইউজারনেম লোড
    const referrerIds = Object.keys(referrerMap);
    if (referrerIds.length > 0) {
        const referrerDocs = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', referrerIds).get();
        referrerDocs.forEach(doc => {
            referrerMap[doc.id].username = doc.data().username;
        });
    }

    const warningUsers = new Set();
    Object.values(deviceMap).forEach(arr => {
      if (arr.length > 1) arr.forEach(id => warningUsers.add(id));
    });

    usersList.innerHTML = '';
    
    users.forEach(u => {
      const isWarning = warningUsers.has(u.id);
      if (userFilter === 'green' && isWarning) return;
      if (userFilter === 'warning' && !isWarning) return;
      
      const regDate = u.registeredAt ? new Date(u.registeredAt.toDate()).toLocaleDateString('bn-BD') : '—';
      const balance = u.balance || 0;
      const isBanned = u.isBanned || false;
      const bannedUntilDate = u.bannedUntil?.toDate();
      const isSuspended = bannedUntilDate && bannedUntilDate > new Date();
      let statusText = 'Active';
      let statusColor = '#00ff88';

      if (isBanned) {
          statusText = 'PERMANENTLY BANNED';
          statusColor = '#ff4444';
      } else if (isSuspended) {
          const untilDateStr = bannedUntilDate.toLocaleDateString('bn-BD');
          statusText = `SUSPENDED until ${untilDateStr}`;
          statusColor = '#ffaa00';
      } else if (isWarning) {
          statusText = 'DEVICE WARNING';
          statusColor = '#ffff00';
      }

      const referrerUsername = referrerMap[u.referrerId]?.username || u.referrerId || 'N/A';


      const item = document.createElement('div');
      item.className = `user-item ${isWarning ? 'warning' : ''} ${isBanned || isSuspended ? 'banned' : ''}`;
      item.innerHTML = `
        <div class="user-details">
          <p><strong>Name:</strong> ${u.name}</p>
          <p><strong>Username:</strong> @${u.username || 'N/A'}</p>
          <p><strong>ID:</strong> ${u.id}</p>
          <p><strong>Balance:</strong> ${isBanned || isSuspended ? 'FREEZED' : balance}৳</p>
          <p><strong>Referrer:</strong> ${referrerUsername}</p>
          <p><strong>Joined:</strong> ${regDate}</p>
          <p style="color:${statusColor};"><strong>Status:</strong> ${statusText}</p>
        </div>
        <div class="user-actions">
          <button class="btn-primary" onclick="window.openBanOptions('${u.id}', '${u.name}', ${isBanned}, ${isSuspended})">
             ${isBanned || isSuspended ? 'Unban' : 'Ban/Suspend'}
          </button>
        </div>
      `;
      usersList.appendChild(item);
    });

    if (users.length === 0) usersList.textContent = 'কোনো ইউজার পাওয়া যায়নি।';
  });
}

// উইথড্র লিস্ট লোড (রিয়েলটাইম)
function loadWithdraws() {
  let query = db.collection('withdraws').orderBy('timestamp', 'desc');
  if (withdrawFilter !== 'all') {
    query = query.where('status', '==', withdrawFilter);
  }

  query.onSnapshot(async snapshot => {
    const withdrawsList = document.getElementById('withdraws-list');
    withdrawsList.innerHTML = 'লোড হচ্ছে...';
    
    let withdraws = [];
    const userIds = new Set();
    snapshot.forEach(doc => {
        const data = { id: doc.id, ...doc.data() };
        withdraws.push(data);
        userIds.add(data.userId);
    });

    // ইউজার ইউজারনেম লোড
    const userMap = {};
    if (userIds.size > 0) {
        const userDocs = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(userIds)).get();
        userDocs.forEach(doc => {
            userMap[doc.id] = doc.data().username;
        });
    }

    withdrawsList.innerHTML = '';

    withdraws.forEach(w => {
      const statusColor = w.status === 'paid' ? '#00ff88' : (w.status === 'pending' ? '#ffaa00' : '#ff4444');
      const timeStr = w.timestamp ? new Date(w.timestamp.toDate()).toLocaleDateString('bn-BD', { hour: '2-digit', minute: '2-digit' }) : '—';
      const username = userMap[w.userId] || 'N/A';

      const item = document.createElement('div');
      item.className = `withdraw-item ${w.status}`;
      item.innerHTML = `
        <div class="withdraw-details">
          <p><strong>User:</strong> @${username} (ID: ${w.userId})</p>
          <p><strong>Amount:</strong> <span style="color:${statusColor};">${w.amount}৳</span></p>
          <p><strong>Method:</strong> ${w.method} - ${w.phone}</p>
          <p><strong>Status:</strong> ${w.status.toUpperCase()}</p>
          <p><strong>Time:</strong> ${timeStr}</p>
          ${w.status === 'rejected' && w.rejectReason ? `<p style="color:#ff4444;"><strong>Reason:</strong> ${w.rejectReason}</p>` : ''}
        </div>
        <div class="payment-actions">
          ${w.status === 'pending' ? `
            <button class="btn-success" onclick="window.markPaid('${w.id}', '${w.userId}', ${w.amount})">Paid</button>
            <button class="btn-cancel" onclick="window.openReject('${w.id}', '${w.userId}', ${w.amount})">Reject</button>
          ` : w.status === 'rejected' ? `
            <button class="btn-primary" onclick="window.markPending('${w.id}', '${w.userId}', ${w.amount})">To Pending</button>
          ` : ''}
        </div>
      `;
      withdrawsList.appendChild(item);
    });
  });
}


// উইথড্র অ্যাকশন
window.markPaid = function(id, userId, amount) {
  if (confirm(`আপনি কি এই ${amount}৳ পেমেন্টটি Paid হিসেবে নিশ্চিত করতে চান?`)) {
    db.collection('withdraws').doc(id).update({ 
      status: 'paid',
      actionTime: firebase.firestore.FieldValue.serverTimestamp()
    });
    // ব্যালেন্স আর কমাতে হবে না কারণ রিকোয়েস্ট করার সময়ই কমানো হয়েছে।
  }
};

window.openReject = function(id, userId, amount) {
  currentDocId = id;
  currentUserId = userId;
  currentAmount = amount;
  document.getElementById('modal-title').textContent = 'রিজেক্ট রিজন';
  document.getElementById('reject-reason').value = '';
  document.getElementById('modal').style.display = 'flex';
};

window.markPending = function(id, userId, amount) {
    if (confirm(`আপনি কি এই রিকোয়েস্টটি আবার Pending করতে চান? ইউজার ${amount}৳ ফেরত পাবে।`)) {
        db.collection('withdraws').doc(id).update({ 
            status: 'pending',
            rejectReason: firebase.firestore.FieldValue.delete(),
            actionTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection('users').doc(userId).update({
            balance: firebase.firestore.FieldValue.increment(-amount) // রিজেক্ট করার সময় যোগ হয়েছিল, এখন পেন্ডিং-এ আনতে বিয়োগ
        });
    }
};

document.getElementById('modal-confirm').onclick = () => {
  const reason = document.getElementById('reject-reason').value;
  db.collection('withdraws').doc(currentDocId).update({ 
    status: 'rejected',
    rejectReason: reason || null,
    actionTime: firebase.firestore.FieldValue.serverTimestamp()
  });
  // ব্যালেন্স ফিরিয়ে দেওয়া
  db.collection('users').doc(currentUserId).update({
    balance: firebase.firestore.FieldValue.increment(currentAmount)
  });
  document.getElementById('modal').style.display = 'none';
};

document.getElementById('modal-cancel').onclick = () => {
  document.getElementById('modal').style.display = 'none';
};


// সাসপেন্ড অপশনস
window.openBanOptions = function(userId, userName, isBanned, isSuspended) {
  if (isBanned || isSuspended) {
      if (confirm(`আপনি কি ইউজার ${userName} কে Unban করতে চান?`)) {
          unbanUser(userId);
      }
      return;
  }
  
  const tempTimes = {
      '1d': '1 Day', '7d': '7 Days', '15d': '15 Days', 
      '30d': '30 Days', '45d': '45 Days', '60d': '60 Days', '90d': '90 Days'
  };
  
  const options = Object.entries(tempTimes).map(([key, label]) => 
      `${key} (${label})`
  ).join(', ');
  
  const choice = prompt(`ইউজার ${userName} কে ব্যান বা সাসপেন্ড করার অপশন দিন:\n\n1. PERMANENTLY BAN\n2. TEMPORARY SUSPEND (যেমন: ${options})\n\nশুধু অপশন নম্বর বা সাসপেন্ড কোড (যেমন: 1, 7d, 30d) লিখুন:`);
  
  if (!choice) return;

  if (choice === '1') {
      if (confirm(`আপনি কি ইউজার ${userName} কে স্থায়ীভাবে ব্যান করতে চান?`)) {
          permBanUser(userId);
      }
  } else if (tempTimes[choice]) {
      if (confirm(`আপনি কি ইউজার ${userName} কে ${tempTimes[choice]} দিনের জন্য সাময়িকভাবে সাসপেন্ড করতে চান?`)) {
          tempSuspendUser(userId, choice);
      }
  } else {
      alert('অকার্যকর অপশন!');
  }
};


// ইউজার ম্যানেজমেন্ট ফাংশন
function unbanUser(userId) {
    db.collection('users').doc(userId).update({
        isBanned: false,
        bannedUntil: firebase.firestore.FieldValue.delete()
    }).then(() => {
        alert('ইউজার সফলভাবে Unbanned হয়েছে।');
    }).catch(e => alert('Unban করতে সমস্যা হয়েছে: ' + e.message));
}

function permBanUser(userId) {
    db.collection('users').doc(userId).update({
        isBanned: true,
        bannedUntil: firebase.firestore.FieldValue.delete()
    }).then(() => {
        alert('ইউজার সফলভাবে Permanent Banned হয়েছে।');
    }).catch(e => alert('Banned করতে সমস্যা হয়েছে: ' + e.message));
}

function tempSuspendUser(userId, durationCode) {
    const durations = {
        '1d': 1, '7d': 7, '15d': 15, '30d': 30, '45d': 45, '60d': 60, '90d': 90
    };
    const days = durations[durationCode];
    if (!days) return;

    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + days);

    db.collection('users').doc(userId).update({
        isBanned: false,
        bannedUntil: futureDate
    }).then(() => {
        alert(`ইউজার সফলভাবে ${days} দিনের জন্য সাময়িকভাবে সাসপেন্ড হয়েছে।`);
    }).catch(e => alert('Suspend করতে সমস্যা হয়েছে: ' + e.message));
}


// সার্চ
document.getElementById('search-user').oninput = () => {
  setTimeout(loadUsers, 300); // ডিবাউন্স
};

  </script>
</body>
</html>