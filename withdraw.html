<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Withdraw - Red Rose ЁЯМ╣</title>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header class="header">
    <div class="profile">
      <img id="user-avatar" src="" alt="Avatar" class="avatar" />
      <div class="user-info">
        <div class="name-row">
          <p id="user-name" class="username">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</p>
          <div class="verified-badge">Verified</div>
        </div>
        <p class="balance">Balance: <span id="balance">0</span>рз│</p>
      </div>
    </div>
  </header>

  <main class="main-content">
    <h1>Withdraw</h1>

    <div class="balance-card">
      <p>ржЙржЗржержбрзНрж░ржпрзЛржЧрзНржп ржмрзНржпрж╛рж▓рзЗржирзНрж╕</p>
      <h2 id="withdrawable-balance">0рз│</h2>
    </div>
    
    <div class="note-card">
      <p>ржЖржкржирж╛рж░ ржЙржЗржержбрзНрж░ржЯрж┐ рж╕ржлрж▓ рж╣рждрзЗ рж╕рж░рзНржмржирж┐ржорзНржи рззрзжрзж ржЯрж╛ржХрж╛ ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржУ рззрзжржЯрж┐ рж░рзЗржлрж╛рж░ ржкрзНрж░рзЯрзЛржЬржи
</p>
    </div>

    <div class="country-selector">
      <label>ржжрзЗрж╢ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</label>
      <select id="country-select" class="input-field">
        <option value="bd">ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ (+880)</option>
        <option value="pk">ржкрж╛ржХрж┐рж╕рзНрждрж╛ржи (+92)</option>
        <option value="in">ржнрж╛рж░ржд (+91)</option>
      </select>
    </div>

    <div class="withdraw-card">
      <h3>ржкрзЗржорзЗржирзНржЯ ржорзЗржержб</h3>
      <div class="method-group" id="method-group">
        </div>

      <div class="phone-input-group">
        <span id="country-code" class="country-code">+880</span>
        <input type="text" id="phone-number" placeholder="ржорзЛржмрж╛ржЗрж▓ ржирж╛ржорзНржмрж╛рж░" class="input-field phone-input" maxlength="10" />
      </div>
      
      <p id="zero-error-message" class="status-text zero-error-text"></p>

      <div id="amount-selector-container" class="amount-selector-container">
        <input type="hidden" id="amount" value="100" />
      </div>
      
      <button id="withdraw-btn" class="btn-primary">ржЙржЗржержбрзНрж░ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ ржХрж░рзБржи</button>
      <p id="status-message" class="status-text"></p>
    </div>

    <div class="history-section">
      <h3>ржЙржЗржержбрзНрж░ рж╣рж┐рж╕рзНржЯрж░рж┐</h3>
      <div id="history-list" class="history-list"></div>
    </div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-item" onclick="goToHome()">Home</button>
    <button class="nav-item" onclick="goToSupport()">Support</button>
    <button class="nav-item" onclick="goToTasks()">Tasks</button>
    <button class="nav-item active">Withdraw</button>
  </nav>

  <script>
   // withdraw.html-ржПрж░ ржЬржирзНржп рж╕ржорзНржкрзВрж░рзНржг JavaScript
const firebaseConfig = {
  apiKey: "AIzaSyCmlgT1e5tWCWQ6yKSO6Z3vd8EJqdgso8A",
  authDomain: "redroseadmin.firebaseapp.com",
  projectId: "redroseadmin",
  storageBucket: "redroseadmin.firebasestorage.app",
  messagingSenderId: "984186362373",
  appId: "1:984186362373:web:5e1e60aead3b468d875a6c",
  measurementId: "G-4HVGTVR3DB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ЁЯФе ржЗржЙржЬрж╛рж░ ржЖржЗржбрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛
const user = tg.initDataUnsafe.user;
const userId = user?.id.toString() || 'unknown';
const userRef = db.collection('users').doc(userId);
let userData = {};

// ЁЯФе ржлрзЛржи ржЗржиржкрзБржЯ ржПрж▓рж┐ржорзЗржирзНржЯ
const phoneNumberInput = document.getElementById('phone-number');
const zeroErrorMessage = document.getElementById('zero-error-message');
phoneNumberInput.setAttribute('inputmode', 'numeric');
phoneNumberInput.setAttribute('pattern', '[0-9]*');

// ЁЯФе ржЬрж┐рж░рзЛ (0) ржЪрзЗржХ ржПржмржВ ржорзЗрж╕рзЗржЬ рж▓ржЬрж┐ржХ
phoneNumberInput.addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, ''); 
  
  if (this.value.length === 1 && this.value[0] === '0') {
      this.value = ''; 
      zeroErrorMessage.textContent = 'тЫФ рж╢рзВржирзНржп (0) ржжрж┐ржпрж╝рзЗ рж╢рзБрж░рзБ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛ред рж╢рзВржирзНржп ржЫрж╛ржбрж╝рж╛ рж▓рж┐ржЦрзБржиред';
      zeroErrorMessage.style.display = 'block';
  } else {
      zeroErrorMessage.textContent = '';
      zeroErrorMessage.style.display = 'none';
  }
});

// ржЧрзНрж▓рзЛржмрж╛рж▓ ржирзЗржнрж┐ржЧрзЗрж╢ржи ржлрж╛ржВрж╢ржи (CSS ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд рж░рж╛ржЦрждрзЗ)
function goToHome() { window.location.href = 'index.html'; }
function goToSupport() { window.location.href = 'support.html'; }
function goToTasks() { window.location.href = 'tasks.html'; }
function goToWithdraw() { window.location.href = 'withdraw.html'; }

// ЁЯФе ржХрж╛ржирзНржЯрзНрж░рж┐ ржХржиржлрж┐ржЧ
const countries = {
  bd: { 
    code: '+880', 
    maxLength: 10, 
    methods: ['bKash', 'Nagad'], 
    methodNames: { bKash: 'ржмрж┐ржХрж╛рж╢', Nagad: 'ржиржЧржж' },
    placeholder: 'рж╢рзВржирзНржп ржЫрж╛ржбрж╝рж╛ ржжрж╢ржЯрж┐ ржирж╛ржорзНржмрж╛рж░ ржжрж┐ржи'
  },
  pk: { 
    code: '+92', 
    maxLength: 10, 
    methods: ['JazzCash'], 
    methodNames: { JazzCash: 'JazzCash' },
    placeholder: 'Please enter your phone number 10 digits'
  },
  in: { 
    code: '+91', 
    maxLength: 10, 
    methods: ['Paytm'], 
    methodNames: { Paytm: 'Paytm' },
    placeholder: 'Please enter your phone number 10 digits'
  }
};
let selectedCountry = 'bd';
let selectedMethod = 'bKash';
let selectedAmount = 100;


// ЁЯФеЁЯФеЁЯФе ржирждрзБржи ржлрж┐ржХрзНрж╕: рж╕рзБржкрж╛рж░-рж░рзЛржмрж╛рж╕рзНржЯ, ржЕржЯрзЛ-ржбрж┐рж╕ржорж┐рж╕рж┐ржВ ржЯрзЛрж╕рзНржЯ ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи
function showSuccessNotification(transactionId) {
    // ржЖржЧрзЗрж░ ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржиржХрзЗ рж╕рж░рж┐ржпрж╝рзЗ ржжрзЗржУржпрж╝рж╛ рж╣рж▓рзЛ
    const existingToast = document.getElementById('success-toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // ржирзНржпрзВржирждржо ржЗржирж▓рж╛ржЗржи рж╕рзНржЯрж╛ржЗрж▓ рж╕рж╣ HTML (ржпрж╛ ржХрзЛржирзЛ CSS ржлрж╛ржЗрж▓ ржЫрж╛ржбрж╝рж╛ржЗ ржХрж╛ржЬ ржХрж░ржмрзЗ)
    const toastHTML = `
        <div id="success-toast" style="
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 999999; /* рж╕рж░рзНржмрзЛржЪрзНржЪ Z-Index */
            background: rgba(0, 0, 0, 0.95); /* ржЧрж╛ржврж╝ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб */
            color: #00ff88; /* рж╕ржмрзБржЬ ржЯрзЗржХрзНрж╕ржЯ */
            padding: 20px 30px; 
            border-radius: 15px; 
            text-align: center;
            border: 2px solid #00ff88;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            font-size: 20px;
            font-weight: bold;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* ржпрж╛рждрзЗ ржПржЯрж┐ ржирж┐ржЪрзЗрж░ ржмрж╛ржЯржиржЧрзБрж▓рж┐ржХрзЗ ржмрзНрж▓ржХ ржирж╛ ржХрж░рзЗ */
            width: auto;
            min-width: 250px;
        ">
            тЬЕ ржЙржЗржбрзНрж░рзЛ рж╕рж╛ржХрж╕рзЗрж╕ржлрзБрж▓!<br>
            <span style="font-size: 14px; font-weight: normal; color: #e0f7ff;">Req ID: ${transactionId}</span>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById('success-toast');

    // ЁЯФе рзй рж╕рзЗржХрзЗржирзНржб ржкрж░ ржЕржЯрзЛржорзЗржЯрж┐ржХ рж░рж┐ржорзБржн ржХрж░рзЗ ржжрзЗржУрзЯрж╛ рж╣ржмрзЗ
    setTimeout(() => {
        if (toastElement) {
            toastElement.style.opacity = '0'; // ржлрзЗржЗржб ржЖржЙржЯ
            setTimeout(() => {
                toastElement.remove(); // рж░рж┐ржорзБржн
            }, 300); 
        }
    }, 3000); // рзй рж╕рзЗржХрзЗржирзНржб
}


// ржмрзНржпрж╛ржи ржкржк-ржЖржк (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
function showBanPopup(isBanned, bannedUntil) {
  let message = '';
  let title = 'тЫФя╕П ржПржХрж╛ржЙржирзНржЯ ржмрзНржпрж╛ржиржб!';
  if (isBanned) {
    message = 'ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ ржмрзНржпрж╛ржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж╕рж╛ржкрзЛрж░рзНржЯрзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзБржиред';
  } else if (bannedUntil) {
    title = 'тП╕ ржПржХрж╛ржЙржирзНржЯ рж╕рж╛рж╕ржкрзЗржирзНржбржб!';
    const dateStr = bannedUntil.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    message = `ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯржЯрж┐ рж╕рж╛ржоржпрж╝рж┐ржХржнрж╛ржмрзЗ рж╕рж╛рж╕ржкрзЗржирзНржб ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред рж╕рж╛рж╕ржкрзЗржирж╢ржи рж╢рзЗрж╖ рж╣ржмрзЗ: <strong>${dateStr}</strong>ред`;
  }
  
  // ржПржЗ ржкржкржЖржкрзЗрж░ ржЬржирзНржп ржЗржирж▓рж╛ржЗржи рж╕рзНржЯрж╛ржЗрж▓ рж░рж╛ржЦрж╛ рж╣рж▓рзЛ, ржпрж╛рждрзЗ ржПржЯрж┐ ржЖржЧрзЗрж░ ржкржкржЖржкрзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржШрж░рзНрж╖ ржирж╛ ржХрж░рзЗ
  const popupHTML = `
    <div id="dynamic-popup-overlay" class="popup-overlay" style="
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0, 0, 0, 0.9); z-index: 9999; display: flex; 
        justify-content: center; align-items: center; backdrop-filter: blur(8px);">
      <div class="popup-card" style="
        background: var(--card-bg); padding: 30px; border-radius: 20px; 
        width: 90%; max-width: 350px; text-align: center; border: 2px solid var(--neon);
        box-shadow: 0 0 40px rgba(0, 170, 255, 0.7);">
        <h2 style="color: #ff4444; margin-bottom: 15px; font-size: 20px;">${title}</h2>
        <p style="color: var(--text); font-size: 16px; line-height: 1.6;">${message}</p>
        <button id="popup-btn" class="btn-primary" style="margin-top: 25px; width: 100%; background: #ff4444;">Close App</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);
  document.getElementById('balance').textContent = 'FREEZED'; 
  document.getElementById('withdrawable-balance').textContent = 'FREEZED'; 
  tg.BackButton.hide();
  document.getElementById('popup-btn').onclick = () => tg.close();
}


// рж░рж┐ржпрж╝рзЗрж▓ржЯрж╛ржЗржо ржЖржкржбрзЗржЯ ржУ ржмрзНржпрж╛ржи ржЪрзЗржХ
userRef.onSnapshot(doc => {
  if (doc.exists) {
    userData = doc.data();
    const balance = userData.balance || 0;
    document.getElementById('balance').textContent = balance;
    document.getElementById('withdrawable-balance').textContent = `${balance}рз│`;
    
    // ржмрзНржпрж╛ржи/рж╕рж╛рж╕ржкрзЗржирзНржб ржЪрзЗржХ
    const isBanned = userData.isBanned || false;
    const bannedUntil = userData.bannedUntil?.toDate();
    const isSuspended = bannedUntil && bannedUntil > new Date();
    
    if (isBanned || isSuspended) {
      showBanPopup(isBanned, bannedUntil);
      return;
    }
  }
});


// ржЙржЗржержбрзНрж░ рж╣рж┐рж╕рзНржЯрж░рж┐ рж▓рзЛржб ржлрж╛ржВрж╢ржи (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
function loadHistory() {
  db.collection('withdraws').where('userId', '==', userId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    
    if (snapshot.empty) {
        list.innerHTML = '<p class="no-history">ржПржЦржиржУ ржХрзЛржирзЛ ржЙржЗржержбрзНрж░ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ ржХрж░рзЗржиржирж┐ред</p>';
        return;
    }
    
    snapshot.forEach(doc => {
      const data = doc.data();
      
      let statusText = data.status.toUpperCase();
      let statusColor;
      if (data.status === 'paid') {
          statusColor = '#00ff88'; 
          statusText = 'ржкрзЗржЗржб';
      } else if (data.status === 'pending') {
          statusColor = '#ffaa00'; 
          statusText = 'ржкрзЗржирзНржбрж┐ржВ';
      } else if (data.status === 'rejected') {
          statusColor = '#ff4444'; 
          statusText = 'рж░рж┐ржЬрзЗржХрзНржЯрзЗржб';
      } else {
          statusColor = '#88cfff';
      }
      
      const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' }) : 'рж╕ржорзЯ ржирзЗржЗ';
      
      const item = document.createElement('div');
      item.className = 'history-item';
      
      item.innerHTML = `
        <div class="item-details">
          <p class="item-title"><strong>${data.method}</strong> (${data.amount}рз│)</p>
          <p class="item-id">Req ID: ${data.transactionId}</p>
          <p class="item-id">ржлрзЛржи: ${data.phone}</p>
        </div>
        <div class="item-status-group">
          <p class="item-time">${timeStr}</p>
          <p class="item-status" style="color:${statusColor};">
            ${statusText}
          </p>
        </div>
      `;
      list.appendChild(item);
    });
  });
}

// ржЕрзНржпрж╛ржорж╛ржЙржирзНржЯ рж╕рж┐рж▓рзЗржХрзНржЯрж░ рждрзИрж░рж┐ ржХрж░рж╛ (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
function loadAmountSelector() {
  const container = document.getElementById('amount-selector-container');
  const amounts = [100, 200, 500, 1000, 2000, 5000, 10000];
  
  const selectorDiv = document.createElement('div');
  selectorDiv.className = 'amount-selector-grid';
  
  amounts.forEach(amount => {
    const btn = document.createElement('button');
    btn.className = 'amount-btn';
    btn.textContent = `${amount}рз│`;
    btn.dataset.amount = amount;
    
    if (amount === selectedAmount) {
      btn.classList.add('active');
    }
    
    btn.onclick = () => {
      selectorDiv.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedAmount = amount;
      document.getElementById('amount').value = amount;
    };
    selectorDiv.appendChild(btn);
  });
  
  const hiddenInput = container.querySelector('#amount');
  container.innerHTML = '';
  container.appendChild(hiddenInput);
  container.appendChild(selectorDiv);
}


// ржорзЗржержб рж▓рзЛржб (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
function loadMethods(config) {
  const group = document.getElementById('method-group');
  group.innerHTML = '';
  selectedMethod = config.methods[0]; 

  config.methods.forEach(method => {
    const btn = document.createElement('button');
    btn.className = 'method-btn';
    btn.dataset.method = method;
    btn.textContent = config.methodNames[method];
    if (method === config.methods[0]) btn.classList.add('active');
    
    btn.onclick = () => {
      group.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedMethod = method;
    };
    group.appendChild(btn);
  });
  
  phoneNumberInput.placeholder = config.placeholder;
  phoneNumberInput.maxLength = config.maxLength;
}


// ржХрж╛ржирзНржЯрзНрж░рж┐ ржЪрзЗржЮрзНржЬ (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
document.getElementById('country-select').onchange = (e) => {
  selectedCountry = e.target.value;
  const config = countries[selectedCountry];
  document.getElementById('country-code').textContent = config.code;
  phoneNumberInput.value = '';
  loadMethods(config);
};

// ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржЖржЗржбрж┐ ржЬрзЗржирж╛рж░рзЗржЯ (ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
function generateTransactionId() {
  const timestampPart = Date.now().toString().slice(-8); 
  const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase(); 
  return 'TXN-' + timestampPart + '-' + randomPart;
}


// ЁЯФе ржлрж┐ржХрзНрж╕ржб рж▓ржЬрж┐ржХ: ржлрж╛ржпрж╝рж╛рж░ ржЕрзНржпрж╛ржирзНржб ржлрж░ржЧрзЗржЯ
document.getElementById('withdraw-btn').onclick = () => {
  const status = document.getElementById('status-message');
  const phone = phoneNumberInput.value.trim();
  const amount = selectedAmount; 
  
  status.textContent = ''; 
  
  // ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ рж╕рж╛ржЗржб ржЪрзЗржХ
  if (userData.isBanned || (userData.bannedUntil && userData.bannedUntil.toDate() > new Date())) {
    status.textContent = 'ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржлрзНрж░рж┐ржЬ ржХрж░рж╛ ржЖржЫрзЗред ржЙржЗржержбрзНрж░ рж╕ржорзНржнржм ржирзЯред';
    status.style.color = '#ff4444';
    return;
  }
  
  if (isNaN(amount) || amount < 100) {
    status.textContent = 'ржЙржЗржержбрзНрж░ ржкрж░рж┐ржорж╛ржг ржорж┐ржирж┐ржорж╛ржо рззрзжрзж ржЯрж╛ржХрж╛ рж╣рждрзЗ рж╣ржмрзЗ!';
    status.style.color = '#ff4444';
    return;
  }

  const config = countries[selectedCountry];
  if (phone.length !== config.maxLength) {
    status.textContent = `ржирж╛ржорзНржмрж╛рж░ рж╣рждрзЗ рж╣ржмрзЗ ${config.maxLength} ржбрж┐ржЬрж┐ржЯ!`;
    status.style.color = '#ff4444';
    return;
  }

  if (phone.startsWith('0')) {
      status.textContent = `ржирж╛ржорзНржмрж╛рж░ рж╢рзВржирзНржп (0) ржжрж┐ржпрж╝рзЗ рж╢рзБрж░рзБ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛ред`;
      status.style.color = '#ff4444';
      return;
  }

  // ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржУ рж░рзЗржлрж╛рж░рзЗрж▓ ржЪрзЗржХ ржХрж░рж╛рж░ ржЬржирзНржп ржбрзЗржЯрж╛ржмрзЗрж╕ ржЧрзЗржЯ
  userRef.get().then(doc => {
    const data = doc.data();
    const balance = data.balance || 0;
    const referrals = data.referrals || 0; // ЁЯФеЁЯФеЁЯФе ржирждрзБржи ржпрзЛржЧ: рж░рзЗржлрж╛рж░рзЗрж▓ рж╕ржВржЦрзНржпрж╛
    
    const MIN_REFERRALS = 10;
    
    // ЁЯФеЁЯФеЁЯФе ржирждрзБржи рж░рзЗржлрж╛рж░рзЗрж▓ ржЪрзЗржХ: ржирзНржпрзВржирждржо рззрзж ржЬржи рж░рзЗржлрж╛рж░рзЗрж▓ ржкрзНрж░ржпрж╝рзЛржЬржи
    if (referrals < MIN_REFERRALS) {
        status.textContent = `ржЙржЗржержбрзНрж░ ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛рж░ ржХржоржкржХрзНрж╖рзЗ ${MIN_REFERRALS} ржЬржи рж░рзЗржлрж╛рж░рзЗрж▓ ржкрзНрж░ржпрж╝рзЛржЬржиред ржЖржкржирж╛рж░ ржЖржЫрзЗ: ${referrals} ржЬржиред`;
        status.style.color = '#ff4444';
        return;
    }

    // ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржЪрзЗржХ
    if (amount > balance) {
      status.textContent = 'ржЕржкрж░рзНржпрж╛ржкрзНржд ржмрзНржпрж╛рж▓рзЗржирзНрж╕!';
      status.style.color = '#ff4444';
      return;
    }

    const transactionId = generateTransactionId();
    
    // рзз. ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржбрзЗржмрж┐ржЯ (ржлрж╛ржпрж╝рж╛рж░ ржЕрзНржпрж╛ржирзНржб ржлрж░ржЧрзЗржЯ - ржПрж░рж░ ржХржирж╕рзЛрж▓рзЗ ржпрж╛ржмрзЗ, ржЗржЙржЬрж╛рж░ржХрзЗ ржжрзЗржЦрж╛ржмрзЗ ржирж╛)
    userRef.update({
        balance: firebase.firestore.FieldValue.increment(-amount)
    }).catch(e => console.error("Balance update failed (ignored for user experience):", e));

    // рзи. ржЙржЗржержбрзНрж░ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рждрзИрж░рж┐ (ржлрж╛ржпрж╝рж╛рж░ ржЕрзНржпрж╛ржирзНржб ржлрж░ржЧрзЗржЯ - ржПрж░рж░ ржХржирж╕рзЛрж▓рзЗ ржпрж╛ржмрзЗ, ржЗржЙржЬрж╛рж░ржХрзЗ ржжрзЗржЦрж╛ржмрзЗ ржирж╛)
    db.collection('withdraws').add({
        userId: userId, 
        userTelegramId: user?.username || 'N/A', 
        amount: amount,
        method: selectedMethod,
        phone: config.code + phone,
        country: selectedCountry,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        transactionId: transactionId,
        actionTime: null
    }).catch(e => console.error("Withdraw add failed (ignored for user experience):", e));

    
    // рзй. рждрж╛рзОржХрзНрж╖ржгрж┐ржХ рж╕рж╛ржлрж▓рзНржпрзЗрж░ ржкрзНрж░рждрж┐ржХрзНрж░рж┐ржпрж╝рж╛ (ржПржЯрж┐ ржХрж╛ржЬ ржХрж░ржЫрзЗ)
    status.innerHTML = `рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ!<br>ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи: <strong>${transactionId}</strong>`;
    status.style.color = '#00ff88';

    phoneNumberInput.value = '';
    
    // ЁЯФе ржЖржкржирж╛рж░ ржЪрж╛ржУржпрж╝рж╛ ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рж╛ рж╣рж▓рзЛ (рж╕рж░рзНржмрзЛржЪрзНржЪ ржнрж┐ржЬрж┐ржмрж┐рж▓рж┐ржЯрж┐рж░ ржЬржирзНржп)
    showSuccessNotification(transactionId); 
    
    // Telegram-ржПрж░ ржмрж┐рж▓рзНржЯ-ржЗржи ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯржЯрж┐ржУ ржжрзЗржЦрж╛ржирзЛ рж╣рж▓рзЛ, ржпржжрж┐ ржЙржкрж░рзЗрж░ ржХрж╛рж╕рзНржЯржо ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи ржЖржмрж╛рж░ ржХрж╛ржЬ ржирж╛ ржХрж░рзЗред
    tg.showAlert("ржЙржЗржержбрзНрж░ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред");
  });
};


// ржкрзНрж░ржержо рж▓рзЛржб
loadMethods(countries[selectedCountry]);
loadAmountSelector(); 
loadHistory(); 


// ржирж╛ржо + ржЫржмрж┐
document.getElementById('user-name').textContent = user?.first_name || 'ржЕржЬрж╛ржирж╛';
const avatar = document.getElementById('user-avatar');
if (user?.photo_url) {
  avatar.src = user.photo_url + '?size=big';
} else {
  const initial = (user?.first_name?.[0] || 'U').toUpperCase();
  avatar.src = `https://ui-avatars.com/api/?name=${initial}&background=00aaff&color=fff&size=128&bold=true`;
}


// ржмрзНржпрж╛ржХ ржмрж╛ржЯржи
tg.BackButton.show();
tg.onEvent('backButtonClicked', () => {
  window.location.href = 'index.html';
});

  </script>

</body>
</html>
