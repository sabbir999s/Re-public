<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Withdraw - Meshchain.Ai</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header class="header">
    <div class="profile">
      <img id="user-avatar" src="" alt="Avatar" class="avatar" />
      <div class="user-info">
        <div class="name-row">
          <p id="user-name" class="username">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
          <div class="verified-badge">Verified</div>
        </div>
        <p class="balance">Balance: <span id="balance">0</span>‡ß≥</p>
      </div>
    </div>
  </header>

  <main class="main-content">
    <h1>Withdraw</h1>

    <div class="balance-card">
      <p>‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
      <h2 id="withdrawable-balance">0‡ß≥</h2>
    </div>

    <div class="country-selector">
      <label>‡¶¶‡ßá‡¶∂ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
      <select id="country-select" class="input-field">
        <option value="bd">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ (+880)</option>
        <option value="pk">‡¶™‡¶æ‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶® (+92)</option>
        <option value="in">‡¶≠‡¶æ‡¶∞‡¶§ (+91)</option>
      </select>
    </div>

    <div class="withdraw-card">
      <h3>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</h3>
      <div class="method-group" id="method-group">
        </div>

      <div class="phone-input-group">
        <span id="country-code" class="country-code">+880</span>
        <input type="text" id="phone-number" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" class="input-field phone-input" maxlength="10" />
      </div>
      
      <p id="zero-error-message" class="status-text zero-error-text"></p>

      <div id="amount-selector-container" class="amount-selector-container">
        <input type="hidden" id="amount" value="100" />
      </div>
      
      <button id="withdraw-btn" class="btn-primary">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <p id="status-message" class="status-text"></p>
    </div>

    <div class="history-section">
      <h3>‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø</h3>
      <div id="history-list" class="history-list"></div>
    </div>
  </main>

  <nav class="bottom-nav">
    <button class="nav-item" onclick="goToHome()">Home</button>
    <button class="nav-item" onclick="goToSupport()">Support</button>
    <button class="nav-item" onclick="goToTasks()">Tasks</button>
    <button class="nav-item active">Withdraw</button>
  </nav>

  <script>
   // withdraw.html-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ JavaScript
const firebaseConfig = {
  apiKey: "AIzaSyCmlgT1e5tWCWQ6yKSO6Z3vd8EJqdgso8A",
  authDomain: "redroseadmin.firebaseapp.com",
  projectId: "redroseadmin",
  storageBucket: "redroseadmin.firebasestorage.app",
  messagingSenderId: "984186362373",
  appId: "1:984186362373:web:5e1e60aead3b468d875a6c",
  measurementId: "G-4HVGTVR3DB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// üî• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ
const user = tg.initDataUnsafe.user;
const userId = user?.id.toString() || 'unknown';
const userRef = db.collection('users').doc(userId);
let userData = {};

// üî• ‡¶´‡ßã‡¶® ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü
const phoneNumberInput = document.getElementById('phone-number');
const zeroErrorMessage = document.getElementById('zero-error-message');
phoneNumberInput.setAttribute('inputmode', 'numeric');
phoneNumberInput.setAttribute('pattern', '[0-9]*');

// üî• ‡¶ú‡¶ø‡¶∞‡ßã (0) ‡¶ö‡ßá‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï
phoneNumberInput.addEventListener('input', function(e) {
  this.value = this.value.replace(/[^0-9]/g, ''); 
  
  if (this.value.length === 1 && this.value[0] === '0') {
      this.value = ''; 
      zeroErrorMessage.textContent = '‚õî ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø (0) ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§';
      zeroErrorMessage.style.display = 'block';
  } else {
      zeroErrorMessage.textContent = '';
      zeroErrorMessage.style.display = 'none';
  }
});

// ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (CSS ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá)
function goToHome() { window.location.href = 'index.html'; }
function goToSupport() { window.location.href = 'support.html'; }
function goToTasks() { window.location.href = 'tasks.html'; }
function goToWithdraw() { window.location.href = 'withdraw.html'; }

// üî• ‡¶ï‡¶æ‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶®‡¶´‡¶ø‡¶ó
const countries = {
  bd: { 
    code: '+880', 
    maxLength: 10, 
    methods: ['bKash', 'Nagad'], 
    methodNames: { bKash: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂', Nagad: '‡¶®‡¶ó‡¶¶' },
    placeholder: '‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶¶‡¶∂‡¶ü‡¶ø ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®'
  },
  pk: { 
    code: '+92', 
    maxLength: 10, 
    methods: ['JazzCash'], 
    methodNames: { JazzCash: 'JazzCash' },
    placeholder: 'Please enter your phone number 10 digits'
  },
  in: { 
    code: '+91', 
    maxLength: 10, 
    methods: ['Paytm'], 
    methodNames: { Paytm: 'Paytm' },
    placeholder: 'Please enter your phone number 10 digits'
  }
};
let selectedCountry = 'bd';
let selectedMethod = 'bKash';
let selectedAmount = 100;


// üî•üî•üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞-‡¶∞‡ßã‡¶¨‡¶æ‡¶∏‡ßç‡¶ü, ‡¶Ö‡¶ü‡ßã-‡¶°‡¶ø‡¶∏‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
function showSuccessNotification(transactionId) {
    // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡¶ï‡ßá ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶≤‡ßã
    const existingToast = document.getElementById('success-toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶á‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∏‡¶π HTML (‡¶Ø‡¶æ ‡¶ï‡ßã‡¶®‡ßã CSS ‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡¶á ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
    const toastHTML = `
        <div id="success-toast" style="
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 999999; /* ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö Z-Index */
            background: rgba(0, 0, 0, 0.95); /* ‡¶ó‡¶æ‡¶¢‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
            color: #00ff88; /* ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü */
            padding: 20px 30px; 
            border-radius: 15px; 
            text-align: center;
            border: 2px solid #00ff88;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            font-size: 20px;
            font-weight: bold;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø‡¶ï‡ßá ‡¶¨‡ßç‡¶≤‡¶ï ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá */
            width: auto;
            min-width: 250px;
        ">
            ‚úÖ ‡¶â‡¶á‡¶°‡ßç‡¶∞‡ßã ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏‡¶´‡ßÅ‡¶≤!<br>
            <span style="font-size: 14px; font-weight: normal; color: #e0f7ff;">Req ID: ${transactionId}</span>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById('success-toast');

    // üî• ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá
    setTimeout(() => {
        if (toastElement) {
            toastElement.style.opacity = '0'; // ‡¶´‡ßá‡¶á‡¶° ‡¶Ü‡¶â‡¶ü
            setTimeout(() => {
                toastElement.remove(); // ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
            }, 300); 
        }
    }, 3000); // ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°
}


// ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶™‡¶™-‡¶Ü‡¶™ (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
function showBanPopup(isBanned, bannedUntil) {
  let message = '';
  let title = '‚õîÔ∏è ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶°!';
  if (isBanned) {
    message = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
  } else if (bannedUntil) {
    title = '‚è∏ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶°‡¶°!';
    const dateStr = bannedUntil.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    message = `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ‡¶π‡¶¨‡ßá: <strong>${dateStr}</strong>‡•§`;
  }
  
  // ‡¶è‡¶á ‡¶™‡¶™‡¶Ü‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡¶™‡¶Ü‡¶™‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶ò‡¶∞‡ßç‡¶∑ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá
  const popupHTML = `
    <div id="dynamic-popup-overlay" class="popup-overlay" style="
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0, 0, 0, 0.9); z-index: 9999; display: flex; 
        justify-content: center; align-items: center; backdrop-filter: blur(8px);">
      <div class="popup-card" style="
        background: var(--card-bg); padding: 30px; border-radius: 20px; 
        width: 90%; max-width: 350px; text-align: center; border: 2px solid var(--neon);
        box-shadow: 0 0 40px rgba(0, 170, 255, 0.7);">
        <h2 style="color: #ff4444; margin-bottom: 15px; font-size: 20px;">${title}</h2>
        <p style="color: var(--text); font-size: 16px; line-height: 1.6;">${message}</p>
        <button id="popup-btn" class="btn-primary" style="margin-top: 25px; width: 100%; background: #ff4444;">Close App</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', popupHTML);
  document.getElementById('balance').textContent = 'FREEZED'; 
  document.getElementById('withdrawable-balance').textContent = 'FREEZED'; 
  tg.BackButton.hide();
  document.getElementById('popup-btn').onclick = () => tg.close();
}


// ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶ö‡ßá‡¶ï
userRef.onSnapshot(doc => {
  if (doc.exists) {
    userData = doc.data();
    const balance = userData.balance || 0;
    document.getElementById('balance').textContent = balance;
    document.getElementById('withdrawable-balance').textContent = `${balance}‡ß≥`;
    
    // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®/‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ö‡ßá‡¶ï
    const isBanned = userData.isBanned || false;
    const bannedUntil = userData.bannedUntil?.toDate();
    const isSuspended = bannedUntil && bannedUntil > new Date();
    
    if (isBanned || isSuspended) {
      showBanPopup(isBanned, bannedUntil);
      return;
    }
  }
});


// ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
function loadHistory() {
  db.collection('withdraws').where('userId', '==', userId).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    
    if (snapshot.empty) {
        list.innerHTML = '<p class="no-history">‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</p>';
        return;
    }
    
    snapshot.forEach(doc => {
      const data = doc.data();
      
      let statusText = data.status.toUpperCase();
      let statusColor;
      if (data.status === 'paid') {
          statusColor = '#00ff88'; 
          statusText = '‡¶™‡ßá‡¶á‡¶°';
      } else if (data.status === 'pending') {
          statusColor = '#ffaa00'; 
          statusText = '‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç';
      } else if (data.status === 'rejected') {
          statusColor = '#ff4444'; 
          statusText = '‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°';
      } else {
          statusColor = '#88cfff';
      }
      
      const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' }) : '‡¶∏‡¶Æ‡ßü ‡¶®‡ßá‡¶á';
      
      const item = document.createElement('div');
      item.className = 'history-item';
      
      item.innerHTML = `
        <div class="item-details">
          <p class="item-title"><strong>${data.method}</strong> (${data.amount}‡ß≥)</p>
          <p class="item-id">Req ID: ${data.transactionId}</p>
          <p class="item-id">‡¶´‡ßã‡¶®: ${data.phone}</p>
        </div>
        <div class="item-status-group">
          <p class="item-time">${timeStr}</p>
          <p class="item-status" style="color:${statusColor};">
            ${statusText}
          </p>
        </div>
      `;
      list.appendChild(item);
    });
  });
}

// ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
function loadAmountSelector() {
  const container = document.getElementById('amount-selector-container');
  const amounts = [100, 200, 500, 1000, 2000, 5000, 10000];
  
  const selectorDiv = document.createElement('div');
  selectorDiv.className = 'amount-selector-grid';
  
  amounts.forEach(amount => {
    const btn = document.createElement('button');
    btn.className = 'amount-btn';
    btn.textContent = `${amount}‡ß≥`;
    btn.dataset.amount = amount;
    
    if (amount === selectedAmount) {
      btn.classList.add('active');
    }
    
    btn.onclick = () => {
      selectorDiv.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedAmount = amount;
      document.getElementById('amount').value = amount;
    };
    selectorDiv.appendChild(btn);
  });
  
  const hiddenInput = container.querySelector('#amount');
  container.innerHTML = '';
  container.appendChild(hiddenInput);
  container.appendChild(selectorDiv);
}


// ‡¶Æ‡ßá‡¶•‡¶° ‡¶≤‡ßã‡¶° (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
function loadMethods(config) {
  const group = document.getElementById('method-group');
  group.innerHTML = '';
  selectedMethod = config.methods[0]; 

  config.methods.forEach(method => {
    const btn = document.createElement('button');
    btn.className = 'method-btn';
    btn.dataset.method = method;
    btn.textContent = config.methodNames[method];
    if (method === config.methods[0]) btn.classList.add('active');
    
    btn.onclick = () => {
      group.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedMethod = method;
    };
    group.appendChild(btn);
  });
  
  phoneNumberInput.placeholder = config.placeholder;
  phoneNumberInput.maxLength = config.maxLength;
}


// ‡¶ï‡¶æ‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ö‡ßá‡¶û‡ßç‡¶ú (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
document.getElementById('country-select').onchange = (e) => {
  selectedCountry = e.target.value;
  const config = countries[selectedCountry];
  document.getElementById('country-code').textContent = config.code;
  phoneNumberInput.value = '';
  loadMethods(config);
};

// ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
function generateTransactionId() {
  const timestampPart = Date.now().toString().slice(-8); 
  const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase(); 
  return 'TXN-' + timestampPart + '-' + randomPart;
}


// üî• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶´‡¶∞‡¶ó‡ßá‡¶ü
document.getElementById('withdraw-btn').onclick = () => {
  const status = document.getElementById('status-message');
  const phone = phoneNumberInput.value.trim();
  const amount = selectedAmount; 
  
  status.textContent = ''; 
  
  // ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶° ‡¶ö‡ßá‡¶ï
  if (userData.isBanned || (userData.bannedUntil && userData.bannedUntil.toDate() > new Date())) {
    status.textContent = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡ßç‡¶∞‡¶ø‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§';
    status.style.color = '#ff4444';
    return;
  }
  
  if (isNaN(amount) || amount < 100) {
    status.textContent = '‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡ßß‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!';
    status.style.color = '#ff4444';
    return;
  }

  const config = countries[selectedCountry];
  if (phone.length !== config.maxLength) {
    status.textContent = `‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá ${config.maxLength} ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü!`;
    status.style.color = '#ff4444';
    return;
  }

  if (phone.startsWith('0')) {
      status.textContent = `‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø (0) ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`;
      status.style.color = '#ff4444';
      return;
  }

  // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ó‡ßá‡¶ü
  userRef.get().then(doc => {
    const balance = doc.data().balance || 0;
    if (amount > balance) {
      status.textContent = '‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏!';
      status.style.color = '#ff4444';
      return;
    }

    const transactionId = generateTransactionId();
    
    // ‡ßß. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶°‡ßá‡¶¨‡¶ø‡¶ü (‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶´‡¶∞‡¶ó‡ßá‡¶ü - ‡¶è‡¶∞‡¶∞ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ)
    userRef.update({
        balance: firebase.firestore.FieldValue.increment(-amount)
    }).catch(e => console.error("Balance update failed (ignored for user experience):", e));

    // ‡ß®. ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø (‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶´‡¶∞‡¶ó‡ßá‡¶ü - ‡¶è‡¶∞‡¶∞ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ)
    db.collection('withdraws').add({
        userId: userId, 
        userTelegramId: user?.username || 'N/A', 
        amount: amount,
        method: selectedMethod,
        phone: config.code + phone,
        country: selectedCountry,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        transactionId: transactionId,
        actionTime: null
    }).catch(e => console.error("Withdraw add failed (ignored for user experience):", e));

    
    // ‡ß©. ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶∏‡¶æ‡¶´‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ (‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá)
    status.innerHTML = `‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!<br>‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®: <strong>${transactionId}</strong>`;
    status.style.color = '#00ff88';

    phoneNumberInput.value = '';
    
    // üî• ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶≠‡¶ø‡¶ú‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    showSuccessNotification(transactionId); 
    
    // Telegram-‡¶è‡¶∞ ‡¶¨‡¶ø‡¶≤‡ßç‡¶ü-‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü‡¶ü‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã, ‡¶Ø‡¶¶‡¶ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡•§
    tg.showAlert("‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
  });
};


// ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡ßã‡¶°
loadMethods(countries[selectedCountry]);
loadAmountSelector(); 
loadHistory(); 


// ‡¶®‡¶æ‡¶Æ + ‡¶õ‡¶¨‡¶ø
document.getElementById('user-name').textContent = user?.first_name || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ';
const avatar = document.getElementById('user-avatar');
if (user?.photo_url) {
  avatar.src = user.photo_url + '?size=big';
} else {
  const initial = (user?.first_name?.[0] || 'U').toUpperCase();
  avatar.src = `https://ui-avatars.com/api/?name=${initial}&background=00aaff&color=fff&size=128&bold=true`;
}


// ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®
tg.BackButton.show();
tg.onEvent('backButtonClicked', () => {
  window.location.href = 'index.html';
});

  </script>

</body>
</html>
